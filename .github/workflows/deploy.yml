name: Deploy Streamlit App to Azure VM

on:
  push:
    branches:
      - main  # Adjust the branch name to your deployment branch

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      # Check out the code from the GitHub repository
      - name: Check out the code
        uses: actions/checkout@v2

      # Install SSH key and set up known_hosts for GitHub Actions
      - name: Set up SSH
        env:
          AZURE_VM_SSH_KEY: ${{ secrets.AZURE_VM_SSH_KEY }}
        run: |
          echo "$AZURE_VM_SSH_KEY" > ~/.ssh/id_rsa
          chmod 600 ~/.ssh/id_rsa
          ssh-keyscan -H ${{ secrets.AZURE_VM_IP }} >> ~/.ssh/known_hosts

      # Deploy the code to the Azure VM
      - name: Deploy to Azure VM
        env:
          AZURE_VM_IP: ${{ secrets.AZURE_VM_IP }}
          AZURE_VM_USERNAME: ${{ secrets.AZURE_VM_USERNAME }}
        run: |
          # Copy the application files to the VM (adjust the path as needed)
          scp -r * $AZURE_VM_USERNAME@$AZURE_VM_IP:/home/$AZURE_VM_USERNAME/streamlit_app/

      # Run the Streamlit app on the Azure VM
      - name: Run Streamlit App
        env:
          AZURE_VM_IP: ${{ secrets.AZURE_VM_IP }}
          AZURE_VM_USERNAME: ${{ secrets.AZURE_VM_USERNAME }}
        run: |
          ssh $AZURE_VM_USERNAME@$AZURE_VM_IP << EOF
            # Change to the application directorygit 
            cd /home/$AZURE_VM_USERNAME/streamlit_app

            # Optionally, create a virtual environment and install dependencies
            # python3 -m venv venv
            # source venv/bin/activate
            # pip install -r requirements.txt

            # Restart the Streamlit application (use tmux or nohup to keep it running in the background)
            pkill -f streamlit || true
            nohup streamlit run app.py --server.port=8501 &
          EOF
